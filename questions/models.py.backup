from django.db import models
from django.conf import settings
from django.utils.translation import gettext_lazy as _


class Fan(models.Model):
    """Fan (Subject) model for categorizing questions"""
    name = models.CharField(max_length=100, verbose_name=_('Fan Name'))
    code = models.CharField(max_length=50, unique=True, verbose_name=_('Fan Code'))
    description = models.TextField(blank=True, verbose_name=_('Description'))
    
    def __str__(self):
        return self.name
    
    class Meta:
        verbose_name = _('Fan')
        verbose_name_plural = _('Fanlar')
        ordering = ['name']


class Paragraph(models.Model):
    """Paragraph model for organizing questions within fans"""
    fan = models.ForeignKey(
        Fan, 
        on_delete=models.CASCADE, 
        related_name='paragraphs',
        verbose_name=_('Fan')
    )
    name = models.CharField(max_length=200, verbose_name=_('Paragraph Name'))
    number = models.PositiveIntegerField(verbose_name=_('Paragraph Number'))
    description = models.TextField(blank=True, verbose_name=_('Description'))
    
    def __str__(self):
        return f"ยง{self.number}. {self.name} ({self.fan.name})"
    
    class Meta:
        verbose_name = _('Paragraph')
        verbose_name_plural = _('Paragraphlar')
        ordering = ['fan__name', 'number']
        unique_together = ['fan', 'number']


class Point(models.Model):
    """Point model for detailed organization within paragraphs"""
    paragraph = models.ForeignKey(
        Paragraph,
        on_delete=models.CASCADE,
        related_name='points',
        verbose_name=_('Paragraph')
    )
    name = models.CharField(max_length=300, verbose_name=_('Point Name'))
    number = models.PositiveIntegerField(verbose_name=_('Point Number'))
    description = models.TextField(blank=True, verbose_name=_('Description'))
    
    def __str__(self):
        return f"{self.paragraph.number}.{self.number}. {self.name}"
    
    class Meta:
        verbose_name = _('Point')
        verbose_name_plural = _('Pointlar')
        ordering = ['paragraph__fan__name', 'paragraph__number', 'number']
        unique_together = ['paragraph', 'number']


class DifficultyLevel(models.TextChoices):
    """Difficulty levels for questions"""
    EASY = 'EASY', _('Easy')
    MEDIUM = 'MEDIUM', _('Medium')
    HARD = 'HARD', _('Hard')


class QuestionStatus(models.TextChoices):
    """Status options for questions"""
    PENDING = 'PENDING', _('Pending Review')
    APPROVED = 'APPROVED', _('Approved')
    REJECTED = 'REJECTED', _('Rejected')
    ARCHIVED = 'ARCHIVED', _('Archived')


class Question(models.Model):
    """Question model with LaTeX support"""
    
    # Basic fields
    fan = models.ForeignKey(
        Fan, 
        on_delete=models.CASCADE,
        related_name='questions',
        verbose_name=_('Fan')
    )
    paragraph = models.ForeignKey(
        Paragraph, 
        on_delete=models.CASCADE,
        related_name='questions',
        verbose_name=_('Paragraph')
    )
    point = models.ForeignKey(
        Point,
        on_delete=models.CASCADE,
        related_name='questions',
        verbose_name=_('Point'),
        null=True,
        blank=True
    )
    difficulty = models.CharField(
        max_length=10,
        choices=DifficultyLevel.choices,
        default=DifficultyLevel.MEDIUM,
        verbose_name=_('Difficulty Level')
    )
    
    # Content fields (with LaTeX support)
    text = models.TextField(verbose_name=_('Question Text in LaTeX'))
    additional_text = models.TextField(blank=True, verbose_name=_('Additional Information in LaTeX'))
    
    # Images or attachments
    image = models.ImageField(
        upload_to='question_images/',
        blank=True, 
        null=True,
        verbose_name=_('Question Image')
    )
    
    # Metadata
    created_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        related_name='created_questions',
        verbose_name=_('Created By')
    )
    created_at = models.DateTimeField(auto_now_add=True, verbose_name=_('Created At'))
    updated_at = models.DateTimeField(auto_now=True, verbose_name=_('Updated At'))
    
    # Review
    status = models.CharField(
        max_length=10,
        choices=QuestionStatus.choices,
        default=QuestionStatus.PENDING,
        verbose_name=_('Status')
    )
    reviewed_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='reviewed_questions',
        verbose_name=_('Reviewed By')
    )
    reviewed_at = models.DateTimeField(null=True, blank=True, verbose_name=_('Reviewed At'))
    review_comment = models.TextField(blank=True, verbose_name=_('Review Comment'))
    
    def __str__(self):
        return f"Question #{self.id} ({self.fan.name})"
    
    class Meta:
        verbose_name = _('Question')
        verbose_name_plural = _('Questions')
        ordering = ['-created_at']


class QuestionOption(models.Model):
    """Model for question options/answers with LaTeX support"""
    question = models.ForeignKey(
        Question,
        on_delete=models.CASCADE,
        related_name='options',
        verbose_name=_('Question')
    )
    text = models.TextField(verbose_name=_('Option Text in LaTeX'))
    is_correct = models.BooleanField(default=False, verbose_name=_('Is Correct Answer'))
    order = models.PositiveSmallIntegerField(default=0, verbose_name=_('Display Order'))
    
    def __str__(self):
        return f"Option for Question #{self.question.id} - {'Correct' if self.is_correct else 'Incorrect'}"
    
    class Meta:
        verbose_name = _('Question Option')
        verbose_name_plural = _('Question Options')
        ordering = ['question', 'order']
        unique_together = ['question', 'order']