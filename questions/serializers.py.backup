from rest_framework import serializers
from django.utils import timezone
from .models import Fan, Paragraph, Point, Question, QuestionOption


class FanSerializer(serializers.ModelSerializer):
    """Serializer for Fan model"""
    
    class Meta:
        model = Fan
        fields = ['id', 'name', 'code', 'description']


class ParagraphSerializer(serializers.ModelSerializer):
    """Serializer for Paragraph model"""
    fan_name = serializers.ReadOnlyField(source='fan.name')
    
    class Meta:
        model = Paragraph
        fields = ['id', 'fan', 'fan_name', 'number', 'name', 'description']


class PointSerializer(serializers.ModelSerializer):
    """Serializer for Point model"""
    paragraph_name = serializers.ReadOnlyField(source='paragraph.name')
    paragraph_number = serializers.ReadOnlyField(source='paragraph.number')
    fan_name = serializers.ReadOnlyField(source='paragraph.fan.name')
    
    class Meta:
        model = Point
        fields = ['id', 'paragraph', 'paragraph_name', 'paragraph_number', 
                  'fan_name', 'number', 'name', 'description']
        

class QuestionOptionSerializer(serializers.ModelSerializer):
    """Serializer for QuestionOption model"""
    
    class Meta:
        model = QuestionOption
        fields = ['id', 'text', 'is_correct', 'order']


class QuestionListSerializer(serializers.ModelSerializer):
    """Serializer for listing questions"""
    
    fan_name = serializers.ReadOnlyField(source='fan.name')
    paragraph_name = serializers.ReadOnlyField(source='paragraph.name')
    paragraph_number = serializers.ReadOnlyField(source='paragraph.number')
    point_name = serializers.ReadOnlyField(source='point.name')
    point_number = serializers.ReadOnlyField(source='point.number')
    created_by_username = serializers.ReadOnlyField(source='created_by.username')
    reviewed_by_username = serializers.ReadOnlyField(source='reviewed_by.username')
    
    class Meta:
        model = Question
        fields = [
            'id', 'fan', 'fan_name', 'paragraph', 'paragraph_name', 'paragraph_number',
            'point', 'point_name', 'point_number',
            'difficulty', 'text', 'status', 'created_at', 'updated_at',
            'created_by', 'created_by_username', 'reviewed_by', 
            'reviewed_by_username', 'reviewed_at'
        ]


class QuestionDetailSerializer(serializers.ModelSerializer):
    """Serializer for question details"""
    
    options = QuestionOptionSerializer(many=True, read_only=True)
    fan_name = serializers.ReadOnlyField(source='fan.name')
    paragraph_name = serializers.ReadOnlyField(source='paragraph.name')
    paragraph_number = serializers.ReadOnlyField(source='paragraph.number')
    point_name = serializers.ReadOnlyField(source='point.name')
    point_number = serializers.ReadOnlyField(source='point.number')
    created_by_username = serializers.ReadOnlyField(source='created_by.username')
    reviewed_by_username = serializers.ReadOnlyField(source='reviewed_by.username')
    
    class Meta:
        model = Question
        fields = [
            'id', 'fan', 'fan_name', 'paragraph', 'paragraph_name', 'paragraph_number',
            'point', 'point_name', 'point_number', 
            'difficulty', 'text', 'additional_text', 'image',
            'created_by', 'created_by_username', 'created_at', 'updated_at',
            'status', 'reviewed_by', 'reviewed_by_username', 'reviewed_at', 
            'review_comment', 'options'
        ]


class QuestionOptionCreateSerializer(serializers.ModelSerializer):
    """Serializer for creating question options"""
    
    class Meta:
        model = QuestionOption
        fields = ['text', 'is_correct', 'order']


class QuestionCreateSerializer(serializers.ModelSerializer):
    """Serializer for creating questions with options"""
    
    options = QuestionOptionCreateSerializer(many=True)
    
    class Meta:
        model = Question
        fields = [
            'fan', 'paragraph', 'point', 'difficulty', 'text', 
            'additional_text', 'image', 'options'
        ]
    
    def validate_options(self, options):
        """Validate that at least one option is marked as correct"""
        if not any(option.get('is_correct', False) for option in options):
            raise serializers.ValidationError(
                "At least one option must be marked as correct."
            )
        return options
    
    def create(self, validated_data):
        # Extract options data
        options_data = validated_data.pop('options')
        
        # Set created_by to current user
        validated_data['created_by'] = self.context['request'].user
        
        # Create question
        question = Question.objects.create(**validated_data)
        
        # Create options
        for option_data in options_data:
            QuestionOption.objects.create(question=question, **option_data)
        
        return question


class QuestionReviewSerializer(serializers.ModelSerializer):
    """Serializer for reviewing questions"""
    
    class Meta:
        model = Question
        fields = ['status', 'review_comment']
    
    def update(self, instance, validated_data):
        validated_data['reviewed_by'] = self.context['request'].user
        validated_data['reviewed_at'] = timezone.now()
        return super().update(instance, validated_data)